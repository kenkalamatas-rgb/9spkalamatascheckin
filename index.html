<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ‡¬ðŸ‡· Soldier Tracker (Firebase Online)</title>

  <!-- Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; margin-bottom: 20px; }
    .tab-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .tabs { display: flex; background: #34495e; }
    .tab { flex: 1; padding: 15px; text-align: center; color: white; cursor: pointer; border: none; background: none; font-size: 16px; }
    .tab.active { background: #2c3e50; font-weight: bold; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    #video-container { text-align: center; position: relative; }
    #video { width: 100%; height: 300px; border-radius: 10px; background: #000; border: 2px solid #ddd; }
    .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid #00ff00; border-radius: 10px; pointer-events: none; }
    .btn { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
    .btn-primary { background: #3498db; }
    .btn-success { background: #27ae60; }
    .btn-danger { background: #e74c3c; }
    .btn-warning { background: #f39c12; }
    .alert { padding: 12px; border-radius: 6px; margin: 10px 0; text-align: center; font-weight: bold; }
    .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

    /* Dashboard table */
    table { width: 100%; border-collapse: collapse; font-size: 15px; border-radius: 8px; overflow: hidden; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #2c3e50; color: #fff; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ðŸ‡¬ðŸ‡· Soldier Tracker</h1>
      <p>Firebase-Connected Check-in/Out System</p>
    </header>

    <div class="tab-container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('scanner')">Scanner</button>
        <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
        <button class="tab" onclick="switchTab('reports')">Reports</button>
      </div>

      <!-- Scanner -->
      <div id="scanner" class="tab-content active">
        <h3>Scan QR Code</h3>
        <div style="text-align:center;">
          <button class="btn btn-primary" onclick="startCamera()" id="startBtn">Start Camera</button>
          <button class="btn btn-danger" onclick="stopCamera()" id="stopBtn" style="display:none;">Stop Camera</button>
        </div>

        <div id="video-container">
          <video id="video" playsinline style="display:none;"></video>
          <canvas id="canvas"></canvas>
          <div class="scan-overlay"></div>
        </div>

        <div id="cameraStatus" class="alert alert-warning" style="display:none;">
          Camera is starting... Please allow access.
        </div>

        <div id="soldierInfo" style="display:none; margin-top:20px;">
          <h4>Soldier Info:</h4>
          <p><strong>Name:</strong> <span id="soldierName"></span></p>
          <p><strong>Rank:</strong> <span id="soldierRank"></span></p>
          <div style="margin-top:10px;">
            <button class="btn btn-success" onclick="checkIn()">Check IN</button>
            <button class="btn btn-danger" onclick="checkOut()">Check OUT</button>
            <button class="btn btn-primary" onclick="continueScanning()">Scan Another</button>
          </div>
        </div>
        <div id="alert" class="alert" style="display:none;"></div>
      </div>

      <!-- Dashboard -->
      <div id="dashboard" class="tab-content">
        <h3>Dashboard</h3>
        <button class="btn btn-danger" onclick="resetDatabase()">Reset All Data</button>
        <p>Currently checked-in soldiers will appear here.</p>
        <div id="dashboardTable"></div>
      </div>

      <!-- Reports -->
      <div id="reports" class="tab-content">
        <h3>Reports</h3>
        <input type="date" id="reportDate" />
        <button class="btn btn-primary" onclick="generateExcelReport()">Download Excel Report</button>
        <div id="reportResults" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // --- Firebase Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyDtcbrXsbnsaF3UnOytjX50YT7AERwjWJs",
      authDomain: "finalcheckin-7910c.firebaseapp.com",
      databaseURL: "https://finalcheckin-7910c-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "finalcheckin-7910c",
      storageBucket: "finalcheckin-7910c.firebasestorage.app",
      messagingSenderId: "344047110499",
      appId: "1:344047110499:web:256be73a4b5c75d558ab56"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.database.INTERNAL.forceWebSockets_ = false;

    const db = firebase.database();
    const recordsRef = db.ref("records");

    let firebaseRecords = [];
    let currentSoldier = null;
    let videoStream = null;
    let scanning = false;
    let canvasContext = null;

    console.log("âœ… Firebase initialized (long-polling mode). Listening for data...");

    // âœ… Dashboard: only show soldiers whose latest record is "IN"
    document.addEventListener("DOMContentLoaded", () => {
      const dashboardTable = document.getElementById("dashboardTable");

      recordsRef.on("value", (snapshot) => {
        const data = snapshot.val();
        firebaseRecords = data ? Object.values(data) : [];
        console.log("ðŸ“¡ Firebase synced:", firebaseRecords.length, "records");

        // group by soldier ID and keep the latest record
        const lastActions = {};
        firebaseRecords.forEach(r => {
          if (!r.id) return;
          if (!lastActions[r.id] || new Date(r.timestamp) > new Date(lastActions[r.id].timestamp)) {
            lastActions[r.id] = r;
          }
        });

        const active = Object.values(lastActions).filter(r => r.action === "IN");

        if (!active.length) {
          dashboardTable.innerHTML = "<p>No soldiers currently checked in.</p>";
          return;
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Rank</th>
                <th>Checked In Time</th>
              </tr>
            </thead>
            <tbody>
        `;

        active.forEach(r => {
          const time = new Date(r.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          html += `
            <tr>
              <td>${r.fullName || "Unknown"}</td>
              <td>${r.rank || "Unknown"}</td>
              <td>${time}</td>
            </tr>
          `;
        });

        html += "</tbody></table>";
        dashboardTable.innerHTML = html;
      });
    });

    // âœ… Reset Firebase database
    function resetDatabase() {
      if (confirm("âš ï¸ Are you sure you want to delete ALL records?")) {
        recordsRef.remove();
        alert("Database reset complete.");
      }
    }

    // âœ… Excel report
    function generateExcelReport() {
      const date = document.getElementById("reportDate").value;
      if (!date) return alert("Select a date first!");

      const records = firebaseRecords.filter(r => r.date === date);
      if (!records.length) return alert("No records for that date.");

      const grouped = {};
      for (const r of records) {
        if (!grouped[r.id]) grouped[r.id] = [];
        grouped[r.id].push(r);
      }

      const rows = [["Name", "Rank", "Check-In Time", "Check-Out Time", "Total Hours"]];
      for (const id in grouped) {
        const entries = grouped[id].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        const firstIn = entries.find(e => e.action === "IN");
        const lastOut = [...entries].reverse().find(e => e.action === "OUT");
        if (firstIn && lastOut) {
          const checkInTime = new Date(firstIn.timestamp);
          const checkOutTime = new Date(lastOut.timestamp);
          const diffHrs = ((checkOutTime - checkInTime) / 3600000).toFixed(2);
          rows.push([firstIn.fullName, firstIn.rank, checkInTime.toLocaleTimeString(), checkOutTime.toLocaleTimeString(), diffHrs]);
        }
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `Soldier_Report_${date}.xlsx`);
    }

    // --- Scanner + Firebase logic ---
    function switchTab(tabName) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById(tabName).classList.add("active");
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
      if (tabName !== "scanner") stopCamera();
    }

    function initializeCanvas() {
      const canvas = document.getElementById("canvas");
      canvasContext = canvas.getContext("2d", { willReadFrequently: true });
    }

    async function startCamera() {
      try {
        showCameraStatus("Starting camera...");
        const video = document.getElementById("video");
        video.style.display = "block";
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        video.onloadedmetadata = () => {
          video.play();
          document.getElementById("startBtn").style.display = "none";
          document.getElementById("stopBtn").style.display = "inline-block";
          hideCameraStatus();
          scanning = true;
          scanQRCode();
        };
      } catch (err) {
        console.error(err);
        showCameraStatus("Camera access denied. Please allow permissions.");
      }
    }

    function stopCamera() {
      if (videoStream) videoStream.getTracks().forEach(track => track.stop());
      videoStream = null;
      scanning = false;
      document.getElementById("video").style.display = "none";
      document.getElementById("startBtn").style.display = "inline-block";
      document.getElementById("stopBtn").style.display = "none";
      hideCameraStatus();
    }

    function showCameraStatus(msg) {
      const el = document.getElementById("cameraStatus");
      el.textContent = msg;
      el.style.display = "block";
    }
    function hideCameraStatus() { document.getElementById("cameraStatus").style.display = "none"; }

    function scanQRCode() {
      if (!scanning) return;
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        if (code) {
          const soldier = parseVCard(code.data);
          if (soldier) {
            currentSoldier = soldier;
            displaySoldierInfo(soldier);
            stopCamera();
          }
        }
      }
      if (scanning) requestAnimationFrame(scanQRCode);
    }

    function parseVCard(text) {
      const lines = text.split("\n");
      const data = {};
      for (let l of lines) {
        if (l.startsWith("FN:")) data.fullName = l.replace("FN:", "").trim();
        if (l.startsWith("N:")) {
          const [last, first] = l.replace("N:", "").split(";");
          data.lastName = last; data.firstName = first;
        }
        if (l.startsWith("TITLE:")) data.rank = l.replace("TITLE:", "").trim();
        if (l.startsWith("UID:")) data.id = l.replace("UID:", "").trim();
      }
      if (!data.id) data.id = data.fullName;
      if (!data.rank) data.rank = "Unknown";
      return data;
    }

    function displaySoldierInfo(soldier) {
      document.getElementById("soldierName").textContent = soldier.fullName;
      document.getElementById("soldierRank").textContent = soldier.rank;
      document.getElementById("soldierInfo").style.display = "block";
      showAlert(`Scanned ${soldier.fullName}`, "success");
    }

    function continueScanning() {
      document.getElementById("soldierInfo").style.display = "none";
      startCamera();
    }

    function checkIn() {
      if (!currentSoldier) return;
      const record = {
        ...currentSoldier,
        action: "IN",
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString("en-CA")
      };
      recordsRef.push(record);
      showAlert(`${record.fullName} checked IN`, "success");
    }

    function checkOut() {
      if (!currentSoldier) return;
      const record = {
        ...currentSoldier,
        action: "OUT",
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString("en-CA")
      };
      recordsRef.push(record);
      showAlert(`${record.fullName} checked OUT`, "success");
    }

    function showAlert(msg, type) {
      const el = document.getElementById("alert");
      el.textContent = msg;
      el.style.display = "block";
      el.className = `alert alert-${type}`;
      setTimeout(() => (el.style.display = "none"), 3000);
    }

    window.switchTab = switchTab;
    document.addEventListener("DOMContentLoaded", initializeCanvas);
  </script>
</body>
</html>
